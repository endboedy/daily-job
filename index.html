<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Monitoring Equipment</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      font-size: 12px;
    }

    h2 { margin-bottom: 5px; }
    .date-display { margin-bottom: 15px; font-size: 12px; color: #555; }

    table {
      border-collapse: collapse;
      margin-bottom: 20px;
      width: 100%;
      font-weight: normal;
      page-break-inside: avoid;
    }

    th, td {
      border: 1px solid #999;
      padding: 3px;
      font-size: 11px;
    }

    .small { width: 50px; }
    .medium { width: 80px; }
    .large { width: 120px; }

    .text-left { text-align: left; }
    .text-right { text-align: right; }
    .text-center { text-align: center; }

    /* warna kategori */
    .category-row {
      background: #ffeb99 !important;
      text-align: left;
      font-weight: bold;
      border: 1px solid #999 !important;
      -webkit-print-color-adjust: exact !important;
      print-color-adjust: exact !important;
    }
    .category-row td { font-size: 12px; padding: 4px; }

    /* warna header */
    .header-row {
      background: #cce5ff !important;
      font-weight: bold;
      -webkit-print-color-adjust: exact !important;
      print-color-adjust: exact !important;
    }

    .btn {
      padding: 3px 8px;
      margin: 2px;
      cursor: pointer;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 3px;
      font-size: 11px;
    }

    .btn:hover { background: #0056b3; }

    .action-btn {
      margin: 0 3px;
      cursor: pointer;
      color: blue;
      text-decoration: underline;
      font-size: 11px;
    }

    input {
      width: 95%;
      padding: 2px;
      font-size: 12px;
    }

    .top-bar {
      display: flex;
      justify-content: flex-end;
      align-items: center;
      margin-bottom: 10px;
      gap: 6px;
    }

    #loadFile { display: none; }

    .custom-file-label {
      padding: 3px 8px;
      background: #6c757d;
      color: white;
      border-radius: 3px;
      font-size: 12px;
      cursor: pointer;
    }

    .custom-file-label:hover { background: #5a6268; }

    @page {
      size: A4 landscape;
      margin: 5mm;
    }

    @media print {
      body { font-size: 9px; margin: 5px; }
      .top-bar, .btn, .action-btn, input, td:last-child, th:last-child { display: none !important; }
      table { font-size: 9px; }
      th, td { padding: 2px; }
      h2 { font-size: 12px; margin-bottom: 5px; }
      .category-row td {
        background: #ffeb99 !important;
        font-weight: bold;
        border: 1px solid #999 !important;
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
      }
      .header-row th {
        background: #cce5ff !important;
        font-weight: bold;
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
      }
    }
  </style>
</head>
<body>

  <h2>Monitoring Equipment</h2>
  <div class="date-display" id="currentDate"></div>

  <div class="top-bar">
    <button id="saveBtn" class="btn">Save JSON</button>
    <button id="printBtn" class="btn">Print PDF</button>
    <label for="loadFile" class="custom-file-label">Choose File</label>
    <input type="file" id="loadFile" accept=".json">
  </div>

  <div id="tableContainer"></div>

<script>
const categories = ["Loading", "Hauling", "Auxiliary", "Coal Getting", "Dozing", "Grading", "Water Truck", "Coal Hauling"];
let data = {};
categories.forEach(cat => data[cat] = []);

function renderTable() {
  const container = document.getElementById("tableContainer");
  container.innerHTML = "";

  categories.forEach(cat => {
    let html = `
      <table>
        <tbody>
          <tr class="category-row"><td colspan="9">${cat}</td></tr>
          <tr class="header-row">
            <th class="small text-left">Equipment</th>
            <th class="small text-right">Actual Down Time</th>
            <th class="small text-left">LTR Status</th>
            <th class="large text-left">Action Plan</th>
            <th class="medium text-left">Component Code</th>
            <th class="medium text-left">Location</th>
            <th class="small text-center">BD Aging Days</th>
            <th class="small text-right">Est RFU</th>
            <th class="small text-center">Action</th>
          </tr>
    `;

    data[cat].forEach((row, i) => {
      html += `
        <tr>
          <td class="text-left">${row.equipment}</td>
          <td class="text-right">${row.downTime}</td>
          <td class="text-left">${row.ltr}</td>
          <td class="text-left">${row.action}</td>
          <td class="text-left">${row.compCode}</td>
          <td class="text-left">${row.loc}</td>
          <td class="text-center">${row.bdAging}</td>
          <td class="text-right">${row.rfu}</td>
          <td class="text-center">
            <span class="action-btn" onclick="editRow('${cat}', ${i})">Edit</span>
            <span class="action-btn" onclick="deleteRow('${cat}', ${i})">Delete</span>
          </td>
        </tr>`;
    });

    html += `
      <tr>
        <td colspan="8"></td>
        <td class="text-center"><button class="btn" onclick="addRow('${cat}')">+ Add</button></td>
      </tr>
      </tbody>
      </table>
    `;

    container.innerHTML += html;
  });
}

function addRow(cat) {
  data[cat].push({
    equipment: "", downTime: "", ltr: "", compCode: "",
    action: "", loc: "", bdAging: "", rfu: ""
  });
  editRow(cat, data[cat].length - 1);
}

function editRow(cat, idx) {
  const row = data[cat][idx];
  const table = document.getElementById("tableContainer");
  const tables = table.getElementsByTagName("table");
  const rows = tables[categories.indexOf(cat)].rows;
  const tr = rows[idx+2]; // offset karena ada category + header
  tr.innerHTML = `
    <td><input value="${row.equipment}"></td>
    <td><input type="date" value="${row.downTime}"></td>
    <td><input value="${row.ltr}"></td>
    <td><input value="${row.action}"></td>
    <td><input value="${row.compCode}"></td>
    <td><input value="${row.loc}"></td>
    <td>${row.bdAging}</td>
    <td><input type="date" value="${row.rfu}"></td>
    <td class="text-center">
      <span class="action-btn" onclick="saveRow('${cat}', ${idx}, this)">Save</span>
      <span class="action-btn" onclick="renderTable()">Cancel</span>
    </td>
  `;
}

function saveRow(cat, idx, el) {
  const inputs = el.closest("tr").querySelectorAll("input");
  const down = inputs[1].value, rfu = inputs[6].value;
  const bdAging = down ? Math.ceil((new Date() - new Date(down)) / (1000*60*60*24)) : "";

  data[cat][idx] = {
    equipment: inputs[0].value,
    downTime: down,
    ltr: inputs[2].value,
    action: inputs[3].value,
    compCode: inputs[4].value,
    loc: inputs[5].value,
    bdAging: bdAging,
    rfu: rfu
  };
  renderTable();
}

function deleteRow(cat, idx) {
  data[cat].splice(idx, 1);
  renderTable();
}

// Save JSON
document.getElementById("saveBtn").addEventListener("click", () => {
  const blob = new Blob([JSON.stringify(data)], {type: "application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "monitoring.json";
  a.click();
});

// Load JSON
document.getElementById("loadFile").addEventListener("change", function(e){
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = () => {
    data = JSON.parse(reader.result);
    categories.forEach(cat => { if(!data[cat]) data[cat] = []; });
    renderTable();
  };
  reader.readAsText(file);
});

// Print PDF
document.getElementById("printBtn").addEventListener("click", () => {
  window.print();
});

// Tampilkan tanggal
document.getElementById("currentDate").innerText = "Tanggal: " + new Date().toLocaleDateString('id-ID');

renderTable();
</script>
</body>
</html>
